<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <%- include('partials/header') %>

        <main>
            <div class="container">
                <h1>Search Fitness Activities</h1>

                <div class="search-form-container">
                    <form method="GET" action="/search" class="search-form">

                        <div class="form-group">
                            <label for="activity_type">Activity Type:</label>
                            <select id="activity_type" name="activity_type">
                                <option value="">All Activities</option>
                                <option value="Running" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Running' ? 'selected' : '' %>>Running</option>
                                <option value="Cycling" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Cycling' ? 'selected' : '' %>>Cycling</option>
                                <option value="Swimming" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Swimming' ? 'selected' : '' %>>Swimming</option>
                                <option value="Gym" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Gym' ? 'selected' : '' %>>Gym</option>
                                <option value="Yoga" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Yoga' ? 'selected' : '' %>>Yoga</option>
                                <option value="Walking" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Walking' ? 'selected' : '' %>>Walking</option>
                                <option value="Hiking" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Hiking' ? 'selected' : '' %>>Hiking</option>
                                <option value="Other" <%=searchPerformed && searchParams &&
                                    searchParams.activity_type==='Other' ? 'selected' : '' %>>Other</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="date_from">Date From:</label>
                                <input type="date" id="date_from" name="date_from"
                                    value="<%= searchPerformed && searchParams ? searchParams.date_from || '' : '' %>">
                            </div>

                            <div class="form-group">
                                <label for="date_to">Date To:</label>
                                <input type="date" id="date_to" name="date_to"
                                    value="<%= searchPerformed && searchParams ? searchParams.date_to || '' : '' %>">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="duration_min">Min Duration (minutes):</label>
                                <input type="number" id="duration_min" name="duration_min" min="0"
                                    placeholder="e.g., 30"
                                    value="<%= searchPerformed && searchParams ? searchParams.duration_min || '' : '' %>">
                            </div>

                            <div class="form-group">
                                <label for="duration_max">Max Duration (minutes):</label>
                                <input type="number" id="duration_max" name="duration_max" min="0"
                                    placeholder="e.g., 120"
                                    value="<%= searchPerformed && searchParams ? searchParams.duration_max || '' : '' %>">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="calories_min">Min Calories:</label>
                                <input type="number" id="calories_min" name="calories_min" min="0"
                                    placeholder="e.g., 100"
                                    value="<%= searchPerformed && searchParams ? searchParams.calories_min || '' : '' %>">
                            </div>

                            <div class="form-group">
                                <label for="calories_max">Max Calories:</label>
                                <input type="number" id="calories_max" name="calories_max" min="0"
                                    placeholder="e.g., 1000"
                                    value="<%= searchPerformed && searchParams ? searchParams.calories_max || '' : '' %>">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Search</button>
                            <button type="reset" class="btn btn-secondary">Clear</button>
                        </div>
                    </form>
                </div>

                <% if (searchPerformed) { %>
                    <div class="search-results">
                        <h2>Search Results</h2>

                        <% if (error) { %>
                            <div class="alert alert-error">
                                <%= error %>
                            </div>
                            <% } else if (activities && activities.length> 0) { %>
                                <div class="results-bar">
                                    <p class="results-count">Found <%= pagination ? pagination.totalCount :
                                            activities.length %>
                                            <%= (pagination ? pagination.totalCount : activities.length)===1
                                                ? 'activity' : 'activities' %>
                                    </p>
                                    <div class="results-actions">
                                        <div class="sort-controls">
                                            <label for="search-sort">Sort</label>
                                            <select id="search-sort">
                                                <option value="date-desc">Time (newest)</option>
                                                <option value="date-asc">Time (oldest)</option>
                                                <option value="calories-desc">Calories (high→low)</option>
                                                <option value="calories-asc">Calories (low→high)</option>
                                                <option value="duration-desc">Duration (long→short)</option>
                                                <option value="duration-asc">Duration (short→long)</option>
                                            </select>
                                        </div>
                                        <% if (pagination && pagination.totalPages> 1) { %>
                                            <div class="pagination">
                                                <% const currentPage=pagination.page; %>
                                                    <% const totalPages=pagination.totalPages; %>
                                                        <% const pageSize=pagination.pageSize; %>
                                                            <% const params=searchParams || {}; %>
                                                                <% function buildPageUrl(p) { const query=new
                                                                    URLSearchParams(); query.set('page', p);
                                                                    query.set('pageSize', pageSize); if
                                                                    (params.activity_type !==undefined &&
                                                                    params.activity_type !==null) {
                                                                    query.set('activity_type', params.activity_type); }
                                                                    if (params.date_from) { query.set('date_from',
                                                                    params.date_from); } if (params.date_to) {
                                                                    query.set('date_to', params.date_to); } if
                                                                    (params.duration_min) { query.set('duration_min',
                                                                    params.duration_min); } if (params.duration_max) {
                                                                    query.set('duration_max', params.duration_max); } if
                                                                    (params.calories_min) { query.set('calories_min',
                                                                    params.calories_min); } if (params.calories_max) {
                                                                    query.set('calories_max', params.calories_max); }
                                                                    return '/search?' + query.toString(); } %>

                                                                    <% if (currentPage> 1) { %>
                                                                        <a class="page-link"
                                                                            href="<%= buildPageUrl(currentPage - 1) %>">Prev</a>
                                                                        <% } %>

                                                                            <% for (let p=1; p <=totalPages; p++) { %>
                                                                                <a class="page-link <%= p === currentPage ? 'active' : '' %>"
                                                                                    href="<%= buildPageUrl(p) %>">
                                                                                    <%= p %>
                                                                                </a>
                                                                                <% } %>

                                                                                    <% if (currentPage < totalPages) {
                                                                                        %>
                                                                                        <a class="page-link"
                                                                                            href="<%= buildPageUrl(currentPage + 1) %>">Next</a>
                                                                                        <% } %>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>

                                <table class="activities-table" id="search-results-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>User</th>
                                            <th>Activity Type</th>
                                            <th>Duration (min)</th>
                                            <th>Distance (km)</th>
                                            <th>Calories</th>
                                            <th>Notes</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% activities.forEach(function(activity) { %>
                                            <tr data-activity-time="<%= activity.activity_time ? new Date(activity.activity_time).toISOString() : '' %>"
                                                data-duration="<%= activity.duration_minutes || 0 %>"
                                                data-calories="<%= activity.calories_burned || 0 %>">
                                                <td>
                                                    <%= activity.activity_time ? new
                                                        Date(activity.activity_time).toLocaleString() : 'N/A' %>
                                                </td>
                                                <td>
                                                    <%= activity.username %>
                                                </td>
                                                <td>
                                                    <%= activity.activity_type %>
                                                </td>
                                                <td>
                                                    <%= activity.duration_minutes %>
                                                </td>
                                                <td>
                                                    <%= activity.distance_km || 'N/A' %>
                                                </td>
                                                <td>
                                                    <%= activity.calories_burned || 'N/A' %>
                                                </td>
                                                <td>
                                                    <%= activity.notes || '-' %>
                                                </td>
                                                <td>
                                                    <% if (activity.is_public) { %>
                                                        <span class="status-badge status-public">Public</span>
                                                        <% } else { %>
                                                            <span class="status-badge status-private">Private</span>
                                                            <% } %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                                <% } else { %>
                                    <p class="no-results">No activities found matching your search criteria.</p>
                                    <% } %>
                    </div>
                    <% } %>
            </div>
        </main>

        <%- include('partials/footer') %>
            <script src="/js/search-sort.js"></script>
</body>

</html>